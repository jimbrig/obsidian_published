<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=description content="Personal Obsidian Vault Published using MkDocs"><meta name=author content="Jimmy Briggs"><link href=https://vault.jimbrig.com/GCP/Setup%20Cloud%20SQL%20for%20PostgreSQL%20in%20Production/ rel=canonical><link rel="shortcut icon" href=../../img/favicon.ico><title>Setup Cloud SQL for PostgreSQL in Production - Jims Obsidian Vault</title><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.12.0/css/all.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css><link rel=stylesheet href=//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css><link href=//rsms.me/inter/inter.css rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin" rel=stylesheet type=text/css><link href=../../css/bootstrap-custom.min.css rel=stylesheet><link href=../../css/base.min.css rel=stylesheet><link href=../../css/cinder.min.css rel=stylesheet><link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/dracula.min.css><link href=../../css/timeago.css rel=stylesheet><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries --><!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]--></head> <body> <div class="navbar navbar-default navbar-fixed-top" role=navigation> <div class=container> <!-- Collapsed navigation --> <div class=navbar-header> <!-- Expander button --> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <!-- Main title --> <a class=navbar-brand href=../..>Jims Obsidian Vault</a> </div> <!-- Expanded navigation --> <div class="navbar-collapse collapse"> <!-- Main navigation --> <ul class="nav navbar-nav"> <li> <a href=../..>Home</a> </li> <li> <a href=../../setup/ >Setup</a> </li> <li class="dropdown active"> <a href=# class=dropdown-toggle data-toggle=dropdown>Categories <b class=caret></b></a> <ul class=dropdown-menu> <li class=dropdown-submenu> <a tabindex=-1 href>Daily Notes</a> <ul class=dropdown-menu> <li class=dropdown-submenu> <a tabindex=-1 href>Daily</a> <ul class=dropdown-menu> <li> <a href=../../_daily/ >Daily Notes</a> </li> <li> <a href=../../_daily/2020-04-20/ >2020 04 20</a> </li> <li> <a href=../../_daily/2021-04-21/ >2021 04 21</a> </li> <li> <a href=../../_daily/2021-04-22/ >2021 04 22</a> </li> <li> <a href=../../_daily/2021-04-23/ >2021 04 23</a> </li> <li> <a href=../../_daily/2021-04-24/ >2021 04 24</a> </li> <li> <a href=../../_daily/2021-04-25/ >2021 04 25</a> </li> <li> <a href=../../_daily/2021-04-28/ >2021 04 28</a> </li> <li> <a href=../../_daily/2021-04-29/ >2021 04 29</a> </li> <li> <a href=../../_daily/2021-05-01/ >2021 05 01</a> </li> <li> <a href=../../_daily/2021-05-02/ >2021 05 02</a> </li> <li> <a href=../../_daily/2021-05-03/ >2021 05 03</a> </li> <li> <a href=../../_daily/2021-05-04/ >2021 05 04</a> </li> </ul> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Featured</a> <ul class=dropdown-menu> <li class=dropdown-submenu> <a tabindex=-1 href>R</a> <ul class=dropdown-menu> <li> <a href=../../R/ >R</a> </li> <li> <a href=../../R/Base%20Package%20Hidden%20Gems%20in%20R/ >Base Package Hidden Gems in R ðŸ’Ž</a> </li> <li> <a href=../../R/Data%20Validation%20Packages%20in%20R/ >Data Validation Packages and Tools in R</a> </li> <li> <a href=../../R/Databases%20with%20R%20Resources/ >Databases with R Resources</a> </li> <li> <a href=../../R/EDA%20Packages%20in%20R/ >EDA Packages in R</a> </li> <li> <a href=../../R/Plumber%20Logging/ >Plumber Logging</a> </li> <li> <a href=../../R/Plumber%20REST%20APIs%20in%20R/ >Building REST APIs with R and Plumber</a> </li> <li> <a href=../../R/Plumber%20Resources/ >Plumber Resources</a> </li> <li> <a href=../../R/R%20Books/ >R-Books</a> </li> <li> <a href=../../R/R%20Development/ >R Development</a> </li> <li> <a href=../../R/R%20Miscellaneous%20Notes/ >R Miscellaneous Notes</a> </li> <li> <a href=../../R/R%20Shiny%20Packages/ >R Shiny Resources</a> </li> <li> <a href=../../R/RStudio%20Configuration%20Notes/ >RStudio Configuration</a> </li> <li> <a href=../../R/Shiny%20Apps%20as%20Packages%20in%20R/ >Shiny Apps as Packages in R</a> </li> <li> <a href=../../R/Tools%20Package%20Hidden%20Gems%20in%20R/ >Tools Package Hidden Gems in R</a> </li> <li> <a href=../../R/Useful%20Packages%20in%20R%20List/ >Useful R Packages to Look Into</a> </li> <li> <a href=../../R/Utils%20Package%20Hidden%20Gems%20in%20R/ >Utils Package Hidden Gems</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>GCP</a> <ul class=dropdown-menu> <li> <a href=../ >GCP</a> </li> <li> <a href=../Google%20Cloud%20APIs/ >Google Cloud APIs</a> </li> <li> <a href=../Google%20Cloud%20Setup%20Notes/ >Google Cloud Setup Notes</a> </li> <li> <a href=../Install%20gcloud%20SDK%20on%20Ubuntu/ >Install gcloud SDK on Ubuntu</a> </li> <li> <a href=../Install%20gcloud%20SDK%20on%20Windows/ >Install gcloud SDK on Windows</a> </li> <li class=active> <a href=./ >Setup Cloud SQL for PostgreSQL in Production</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Databases</a> <ul class=dropdown-menu> <li> <a href=../../Databases/ >Databases</a> </li> <li> <a href=../../Databases/Database%20GUIs/ >Database GUIs</a> </li> <li> <a href=../../Databases/Databases/ >Databases - MOC</a> </li> <li> <a href=../../Databases/PostgreSQL%20Tools/ >PostgreSQL Tools</a> </li> <li> <a href=../../Databases/PostgreSQL/ >PostgreSQL</a> </li> <li> <a href=../../Databases/Views%20vs.%20Materialized%20Views/ >Views vs. Materialized Views</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Windows</a> <ul class=dropdown-menu> <li> <a href=../../Windows/ >Windows</a> </li> <li> <a href=../../Windows/How%20to%20Cleanup%20Windows%20from%20Command%20Line/ >How to Cleanup Windows from Command Line</a> </li> <li> <a href=../../Windows/SFC%20and%20DISM%20Commands/ >SFC Scannow and DISM Commands</a> </li> <li> <a href=../../Windows/Using%20diskusage%20Command%20in%20Windows/ >Using diskusage Command in Windows</a> </li> <li> <a href=../../Windows/WinGet%20CLI%20Setup%20and%20Settings/ >WinGet CLI Settings</a> </li> <li> <a href=../../Windows/Windows%20Command%20Line%20Commands%20Overview/ >Windows Command Prompt</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>WSL</a> <ul class=dropdown-menu> <li> <a href=../../WSL/ >WSL</a> </li> <li> <a href=../../WSL/WSL%20Commands%20and%20Installs/ >WSL Commands and Installs</a> </li> <li> <a href=../../WSL/WSL%20Ubuntu%20on%20Windows%20Community%20Preview/ >WSL Ubuntu on Windows Community Preview</a> </li> <li> <a href=../../WSL/WSL/ >WSL- Contents</a> </li> <li> <a href=../../WSL/WSLg/ >WSLg</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>System Design</a> <ul class=dropdown-menu> <li> <a href=../../System%20Design/ >System Design</a> </li> <li> <a href=../../System%20Design/System%20Design%20Primer/ >System Design Primer</a> </li> <li> <a href=../../System%20Design/System%20Design/ >System Design</a> </li> </ul> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Everything</a> <ul class=dropdown-menu> <li class=dropdown-submenu> <a tabindex=-1 href>Cloud</a> <ul class=dropdown-menu> <li> <a href=../../Cloud/ >Cloud</a> </li> <li> <a href=../../Cloud/Google%20Cloud%20Setup%20Notes/ >Google Cloud Setup Notes</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Developer Tools</a> <ul class=dropdown-menu> <li> <a href=../../Developer%20Tools/ >Developer Tools</a> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Web Browsers</a> <ul class=dropdown-menu> <li> <a href=../../Developer%20Tools/Web%20Browsers/ >Web Browsers</a> </li> <li> <a href=../../Developer%20Tools/Web%20Browsers/Firefox%20Developer%20Edition/ >Firefox Developer Edition</a> </li> <li> <a href=../../Developer%20Tools/Web%20Browsers/Web%20Browsers/ >Web Browsers</a> </li> </ul> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Docker</a> <ul class=dropdown-menu> <li> <a href=../../Docker/ >Docker</a> </li> <li> <a href=../../Docker/Docker%20Compose%20Reference%20Docs/ >Docker Compose Reference Docs</a> </li> <li> <a href=../../Docker/Docker/ >Docker Best Practices</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Documentation</a> <ul class=dropdown-menu> <li> <a href=../../Documentation/ >Documentation</a> </li> <li> <a href=../../Documentation/MkDocs/ >MkDocs</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Git</a> <ul class=dropdown-menu> <li> <a href=../../Git/ >Git</a> </li> <li> <a href=../../Git/Git%20Tools/ >Git Tools</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Github</a> <ul class=dropdown-menu> <li> <a href=../../Github/ >Github</a> </li> <li> <a href=../../Github/Github%20Actions%20for%20R/ >Github Actions for R</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Lists</a> <ul class=dropdown-menu> <li> <a href=../../Lists/ >Lists</a> </li> <li> <a href=../../Lists/Recurring%20Shopping%20List/ >Recurring Shopping List</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Obsidian</a> <ul class=dropdown-menu> <li> <a href=../../Obsidian/ >Obsidian</a> </li> <li> <a href=../../Obsidian/Mermaid%20Diagrams/ >Mermaid Diagrams</a> </li> <li> <a href=../../Obsidian/Obsidian%20Git%20Plugin%20Notes/ >Obsidian Git Plugin Notes</a> </li> <li> <a href=../../Obsidian/Obsidian/ >Obsidian</a> </li> <li> <a href=../../Obsidian/Publishing%20Workflow/ >Publishing Workflow</a> </li> <li> <a href=../../Obsidian/Templater%20Plugin%20Notes/ >Templater Plugin Notes</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>PKM</a> <ul class=dropdown-menu> <li> <a href=../../PKM/ >PKM</a> </li> <li> <a href=../../PKM/PKM/ >PKM</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Powwater</a> <ul class=dropdown-menu> <li> <a href=../../Powwater/ >Powwater</a> </li> <li> <a href=../../Powwater/Database%20Documentation/ >Database Documentation</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Productivity</a> <ul class=dropdown-menu> <li> <a href=../../Productivity/ >Productivity</a> </li> <li> <a href=../../Productivity/Notes%20on%20Finishing%20Projects/ >Notes on Finishing Projects</a> </li> <li> <a href=../../Productivity/Productivity/ >Productivity</a> </li> <li> <a href=../../Productivity/Time%20Management/ >Time Management</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Project Management</a> <ul class=dropdown-menu> <li> <a href=../../Project%20Management/ >Project Management</a> </li> <li> <a href=../../Project%20Management/Ludicrously%20Complex%20Projects%20in%20Software%20Development/ >Ludicrously Complex Projects</a> </li> <li> <a href=../../Project%20Management/Project%20Management%20Pipeline/ >Project Management Pipeline</a> </li> <li> <a href=../../Project%20Management/Project%20Management/ >Project Management</a> </li> <li> <a href=../../Project%20Management/Taming%20a%20Chaotic%20Project/ >Taming a Chaotic Project</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Python</a> <ul class=dropdown-menu> <li> <a href=../../Python/ >Python</a> </li> <li> <a href=../../Python/Python/ >Python</a> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>R</a> <ul class=dropdown-menu> <li class=dropdown-submenu> <a tabindex=-1 href>Databases with R</a> <ul class=dropdown-menu> <li> <a href=../../R/Databases%20with%20R/ >Databases with R</a> </li> <li> <a href=../../R/Databases%20with%20R/Using%20Pool/ >Using Pool, DBI, and Other Drivers</a> </li> </ul> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Tools</a> <ul class=dropdown-menu> <li> <a href=../../Tools/ >Tools</a> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Web Browsers</a> <ul class=dropdown-menu> <li> <a href=../../Tools/Web%20Browsers/ >Web Browsers</a> </li> <li> <a href=../../Tools/Web%20Browsers/Firefox%20Developer%20Edition/ >Firefox Developer Edition</a> </li> <li> <a href=../../Tools/Web%20Browsers/Web%20Browsers/ >Web Browsers</a> </li> </ul> </li> </ul> </li> <li class=dropdown-submenu> <a tabindex=-1 href>Web Development</a> <ul class=dropdown-menu> <li> <a href=../../Web%20Development/ >Web Development</a> </li> <li> <a href=../../Web%20Development/APIs/ >APIs</a> </li> <li> <a href=../../Web%20Development/Backend%20Web%20Architecture/ >Backend Web Architecture</a> </li> <li> <a href=../../Web%20Development/HTTP%20Requests%20Notes/ >HTTP Requests | Codecademy</a> </li> <li> <a href=../../Web%20Development/Javascript/ >Javascript</a> </li> <li> <a href=../../Web%20Development/WebDev%20Resource%20List/ >WebDev Resource List</a> </li> </ul> </li> </ul> </li> </ul> </li> <li> <a href=../../Changelog/ >Changelog</a> </li> </ul> <ul class="nav navbar-nav navbar-right"> <li> <a href=# data-toggle=modal data-target=#mkdocs_search_modal> <i class="fas fa-search"></i> Search </a> </li> <li> <a href=../Install%20gcloud%20SDK%20on%20Windows/ rel=prev> <i class="fas fa-arrow-left"></i> Previous </a> </li> <li> <a href=../../Databases/ rel=next> Next <i class="fas fa-arrow-right"></i> </a> </li> <li> <a href="https://github.com/jimbrig/obsidian_published/blob/main/docs/GCP/Setup Cloud SQL for PostgreSQL in Production.md">Edit on jimbrig/obsidian_published</a> </li> </ul> </div> </div> </div> <div class=container> <div class=col-md-3><div class="bs-sidebar hidden-print affix well" role=complementary> <ul class="nav bs-sidenav"> <li class="first-level active"><a href=#setup-cloud-sql-for-postgresql-in-production>Setup Cloud SQL for PostgreSQL in Production</a></li> <li class=second-level><a href=#deploying-a-cloud-sql-for-postgresql-instance>Deploying a Cloud SQL for PostgreSQL instance</a></li> <li class=third-level><a href=#instance-selection>Instance selection</a></li> <li class=third-level><a href=#high-availability-configuration>High-availability configuration</a></li> <li class=second-level><a href=#admin-users-and-accounts>Admin users and accounts</a></li> <li class=third-level><a href=#postgres-account>postgres account</a></li> <li class=third-level><a href=#cloudsqlimportexport-account>cloudsqlimportexport account</a></li> <li class=third-level><a href=#account-management-add-delete-or-change-password>Account management (add, delete, or change password)</a></li> <li class=second-level><a href=#monitoring-and-alerting>Monitoring and alerting</a></li> <li class=third-level><a href=#postgresql-database-instance-monitoring>PostgreSQL database instance monitoring</a></li> <li class=third-level><a href=#monitoring-read-replicas>Monitoring read-replicas</a></li> <li class=third-level><a href=#postgresql-database-monitoring>PostgreSQL database monitoring</a></li> <li class=third-level><a href=#alerting>Alerting</a></li> <li class=second-level><a href=#scaling>Scaling</a></li> <li class=second-level><a href=#backup-and-recovery>Backup and recovery</a></li> <li class=second-level><a href=#automation>Automation</a></li> <li class=second-level><a href=#whats-next>What's next</a></li> </ul> </div></div> <div class=col-md-9 role=main> <h2 id=setup-cloud-sql-for-postgresql-in-production>Setup Cloud SQL for PostgreSQL in Production<a class=headerlink href=#setup-cloud-sql-for-postgresql-in-production title="Permanent link">âš‘</a></h2> <h3 id=deploying-a-cloud-sql-for-postgresql-instance>Deploying a Cloud SQL for PostgreSQL instance<a class=headerlink href=#deploying-a-cloud-sql-for-postgresql-instance title="Permanent link">âš‘</a></h3> <p>You can set up a Cloud SQL for PostgreSQL instance in a few steps by using the Google Cloud Console or the <code>gcloud</code> command-line tool. </p> <p>Both methods are described here.</p> <ol> <li>Create the PostgreSQL instance:</li> </ol> <pre class=codehilite><code class=language-powershell>gcloud sql instances create postgresql01 --cpu=2 --memory=7680MB --region=us-central1 --zone=us-central1-a
</code></pre> <ol> <li>Assign a password for the PostgreSQL default user (syntax example):</li> </ol> <pre class=codehilite><code class=language-powershell>gcloud sql users set-password postgres --instance &lt;INSTANCE_NAME&gt; --password &lt;PASSWORD&gt;
</code></pre> <p>You can specify these additional options:</p> <ul> <li><strong>Database version:</strong> One of the supported PostgreSQL <a href=https://cloud.google.com/sql/docs/postgres/db-versions>versions</a>.</li> <li><strong>Storage type:</strong> Either SSD or HDD as the storage type.</li> <li><strong>Storage capacity:</strong> The initial storage settings for the instance.</li> <li><strong>Automatic storage increase:</strong> Cloud SQL automation for adding additional storage when free space runs low.</li> <li><strong>High-availability:</strong> Cloud SQL high-availability.</li> <li><strong>Automatic backups:</strong> The start-time window for backups.</li> <li><strong>Point-in-time recovery:</strong> Point-in-time recovery and write-ahead logging.</li> <li><strong>Maintenance window:</strong> A one-hour window when Cloud SQL can perform disruptive maintenance.</li> <li><strong>Maintenance timing:</strong> The preferred timing for performing updates on the PostgreSQL instance. You can specify <strong>preview</strong> for earlier updates or <strong>production</strong> for later updates.</li> <li><strong>Database flags:</strong> The PostgreSQL database flags for controlling settings and parameters.</li> </ul> <p>The following <code>gcloud</code> command creates a Cloud SQL for PostgreSQL instance with some additional options:</p> <pre class=codehilite><code class=language-powershell>gcloud sql instances create postgresql01 --cpu=2 --memory=7680MB --region=us-central1 --zone=us-central1-a \Â  Â  
        --database-version=POSTGRES_12 --storage-type=SSD --storage-size=100 --storage-auto-increase \
        --availability-type=regional --backup-start-time=23:30 --enable-point-in-time-recovery --maintenance-window-day=sun \
        --maintenance-window-hour=11 --maintenance-release-channel=production --database-flags max_connections=100
</code></pre> <p>For more information, see <a href=https://cloud.google.com/sql/docs/postgres/create-instance#gcloud>Creating instances</a>.</p> <h4 id=instance-selection>Instance selection<a class=headerlink href=#instance-selection title="Permanent link">âš‘</a></h4> <p>Instance selection or sizing involves selecting a machine type that can support your OracleÂ® workload on Cloud SQL for PostgreSQL. The instance types are divided into two main groups:</p> <ul> <li><strong>Shared-core machines</strong>: Cost effective.</li> <li><strong>Dedicated-core instances</strong>: Support multiple vCPUs and memory ratios.</li> </ul> <p>For more information about instance types, see <a href=https://cloud.google.com/sql/pricing#pg-pricing>Cloud SQL pricing</a>.</p> <p>In order to size your instance, start by analyzing the resources allocated to and used by your source database. You can get the Oracle database resources settings from the <a href=https://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2083.htm#REFRN30321><code>V$OSSTAT</code></a> system view or from an Oracle AWR report (see the following examples):</p> <p><strong>Physical memory</strong> (total number of bytes of physical memory in the database server):</p> <pre class=codehilite><code class=language-sql>SQL&gt; SELECT ROUND(MAX(VALUE)/1024/1024/1024) AS MEM_SIZE_GBÂ  Â  Â FROM V$OSSTATÂ  Â  Â WHERE STAT_NAME = 'PHYSICAL_MEMORY_BYTES';
</code></pre> <p><strong>Allocated memory</strong>:</p> <pre class=codehilite><code class=language-sql>SQL&gt; SELECT NAME, VALUE, DISPLAY_VALUE FROM V$PARAMETERÂ  Â  Â WHERE NAME LIKE '%sga%' OR NAME LIKE '%memory%';
</code></pre> <p><strong>CPU cores</strong> (number of CPU cores available):</p> <pre class=codehilite><code class=language-sql>SQL&gt; SELECT VALUE FROM V$OSSTATÂ  Â  Â WHERE STAT_NAME = 'NUM_CPU_CORES';
</code></pre> <p><strong>CPU cores</strong> (identified by an Oracle instance using the <code>V$LICENSE</code> view):</p> <pre class=codehilite><code class=language-sql>SQL&gt; SELECT CPU_CORE_COUNT_CURRENT FROM V$LICENSE;
</code></pre> <p><strong>Oracle AWR report resource example</strong> (An Oracle AWR report can provide additional insights about a specific Oracle instance's workload characteristics):</p> <p><img alt="Oracle AWR report resource example." src=https://cloud.google.com/solutions/images/setting-up-cloud-sql-for-postgresql-awr-report.png></p> <p>When you have the resource information of your source database, we recommend choosing the closest matching Cloud SQL instance type and running some benchmarks. The results from your benchmarks help you finalize your instance selection.</p> <h4 id=high-availability-configuration>High-availability configuration<a class=headerlink href=#high-availability-configuration title="Permanent link">âš‘</a></h4> <p>To implement a disaster recovery solution, similar to Oracle's Data Guard, Cloud SQL for PostgreSQL offers high-availability capabilities that provide automatic failover from the cluster's primary instance to its standby Instance. The standby instance is located in a different zone in the same region as the primary instance. The standby instance is kept in sync through <a href=https://cloud.google.com/compute/docs/disks#repds>synchronous replication</a> between the persistent disks of the primary and standby instances. This method ensures that all data modifications to the primary are also applied to the standby.</p> <p>In the event of a primary failure, such as an unresponsive instance or zone-level failure, Cloud SQL performs an automatic failover. The primary instance is monitored by heartbeats, which occur in 1-second intervals, with a failover activating after approximately 60 seconds of no heartbeats received from the primary instance. At this point, the primary instance fails over to the standby, providing data access to applications or clients transparently, while the existing read-replicas remain operational. Note that unlike Active Data Guard, the standby instance is not open for reads while acting as a standby; with Cloud SQL, only read-replicas can be used to offload reads from the primary.</p> <p>You can enable the Cloud SQL for PostgreSQL high-availability (HA) feature when you create the instance or for an existing PostgreSQL instance. Here are the steps:</p> <ul> <li><a href=https://cloud.google.com/solutions/setting-up-cloud-sql-for-postgresql-for-production#console>Console</a></li> <li><a href=https://cloud.google.com/solutions/setting-up-cloud-sql-for-postgresql-for-production#gcloud>gcloud</a></li> </ul> <p>Gcloud:</p> <ol> <li>Enable HA by setting the <code>availability-type</code> parameter to <code>regional</code>:</li> </ol> <pre class=codehilite><code class=language-powershell>gcloud sql instances create postgresql01 --cpu=2 --memory=7680MB --region=us-central1 --zone=us-central1-a --availability-type=regional
</code></pre> <ol> <li>Check if an existing PostgreSQL instance has HA configured:</li> </ol> <pre class=codehilite><code class=language-powershell>gcloud sql instances describe &lt;INSTANCE_NAME&gt;
</code></pre> <p>If the output from this command includes <code>availabilityType: REGIONAL</code>, then HA is already enabled. If the output includes <code>availabilityType: ZONAL</code>, then HA is not configured and can be enabled using the <code>patch</code> command:</p> <pre class=codehilite><code class=language-powershell>gcloud sql instances patch INSTANCE\_NAME --availability-type REGIONAL
</code></pre> <ol> <li>Initiate a failover test from the primary to the standby:</li> </ol> <pre class=codehilite><code class=language-powershell>gcloud sql instances failover &lt;PRIMARY_INSTANCE_NAME&gt; 
</code></pre> <p>To fail back, run the same failover command on the new primary.</p> <h3 id=admin-users-and-accounts>Admin users and accounts<a class=headerlink href=#admin-users-and-accounts title="Permanent link">âš‘</a></h3> <p>Two default PostgreSQL user accounts come with any Cloud SQL for PostgreSQL installation. These accounts are <code>postgres</code> and <code>cloudsqlimportexport</code>.</p> <h4 id=postgres-account>postgres account<a class=headerlink href=#postgres-account title="Permanent link">âš‘</a></h4> <p>The <code>postgres</code> account is the administrator account and is equivalent to Oracle <code>SYS</code> or <code>SYSTEM</code> users under Cloud PaaS. Because Cloud SQL for PostgreSQL is a managed service, the <code>postgres</code> user, unlike Oracle <code>SYS</code> or <code>SYSTEM</code> users, is restricted from accessing certain system procedures and tables that require advanced privileges.</p> <p>The <code>postgres</code> user is part of the <code>cloudsqlsuperuser</code> role, and has the following attributes (privileges): <code>CREATEROLE</code>, <code>CREATEDB</code>, and <code>LOGIN</code>. It does not have the <code>SUPERUSER</code> or <code>REPLICATION</code> attributes.</p> <h4 id=cloudsqlimportexport-account>cloudsqlimportexport account<a class=headerlink href=#cloudsqlimportexport-account title="Permanent link">âš‘</a></h4> <p>The <code>cloudsqlimportexport</code> account is created with the minimal set of privileges needed for CSV import/export operations. You have the option to create your own users to perform these operations, but if you don't, the default <code>cloudsqlimportexport</code> user is used. The <code>cloudsqlimportexport</code> user is a system user, and you cannot directly use it.</p> <h4 id=account-management-add-delete-or-change-password>Account management (add, delete, or change password)<a class=headerlink href=#account-management-add-delete-or-change-password title="Permanent link">âš‘</a></h4> <p>Account management entails creating new user accounts, modifying the password of an existing account, and deleting an account that is no longer needed. You can perform these account operations through the Cloud Console, the <a href=https://cloud.google.com/sql/docs/mysql/create-manage-users><code>gcloud</code></a> tool, or the PostgreSQL client.</p> <ol> <li>List the existing user accounts:</li> </ol> <pre class=codehilite><code class=language-powershell>gcloud sql users list --instance=postgresql01
</code></pre> <p>The output is similar to the following:</p> <pre class=codehilite><code class=language-powershell>NAME Â  Â  Â  HOSTPostgres
</code></pre> <ol> <li>Create the <code>appuser</code> user account, set the password, and delete <code>appuser</code>:</li> </ol> <pre class=codehilite><code class=language-powershell>gcloud sql users create appuser --instance=postgresql01 --password=&lt;PASSWORD&gt;

gcloud sql users set-password appuser --host=% --instance=postgresql01 --prompt-for-password

gcloud sql users delete appuser --instance=postgresql01
</code></pre> <h3 id=monitoring-and-alerting>Monitoring and alerting<a class=headerlink href=#monitoring-and-alerting title="Permanent link">âš‘</a></h3> <p><a href=https://cloud.google.com/logging>Cloud Logging</a> is the main logging tool on Google Cloud. It is used for collecting and viewing a variety of monitoring logs for resources such as Cloud SQL for PostgreSQL.</p> <p>Cloud Logging lets you view logs for Cloud SQL for PostgreSQL filtered by event level (for example, Critical, Error, or Warning), event timeframe, and free text search, as in the following screenshot.</p> <p><img alt="Viewing logs in Cloud Logging." src=https://cloud.google.com/solutions/images/setting-up-cloud-sql-for-postgresql-logging.png></p> <h4 id=postgresql-database-instance-monitoring>PostgreSQL database instance monitoring<a class=headerlink href=#postgresql-database-instance-monitoring title="Permanent link">âš‘</a></h4> <p>Oracle's main monitoring tools are Enterprise Manager and Grid/Cloud Control. These tools let you do real-time database instance monitoring at a database session and SQL statement level.</p> <p>Cloud SQL for PostgreSQL provides comparable monitoring capabilities through the Cloud Console. From there, you can get a summary view of your database instances, including CPU utilization, storage usage, memory usage, read/write operations, active connections, transactions per second, and ingress/egress bytes. Note that Google Cloud's operations suite provides <a href=https://cloud.google.com/monitoring/api/metrics_gcp#gcp-cloudsql>additional monitoring metrics</a> for Cloud SQL for PostgreSQL, such as auto-failover requests and replication lag between the primary and read-replicas.</p> <p>The following example graph shows a graph of transactions per second for the last 6 hours:</p> <p><img alt="Graph of transactions per second for the
last 6 hours." src=https://cloud.google.com/solutions/images/setting-up-cloud-sql-for-postgresql-graph.png></p> <h4 id=monitoring-read-replicas>Monitoring read-replicas<a class=headerlink href=#monitoring-read-replicas title="Permanent link">âš‘</a></h4> <p>You can monitor read-replicas through the Cloud Console the same way that you monitor the primary instance. There are specific metrics for checking the replication status between the primary and read-replica instances. These metrics are used to populate the read-replica instance overview page in the Cloud Console.</p> <p>Alternatively, you can check the replication status from the command line:</p> <pre class=codehilite><code class=language-powershell>gcloud sql instances describe REPLICA\_NAME 
</code></pre> <p>A third option is to check the replication status through a PostgreSQL client. The following PostgreSQL command checks the read-replica status:</p> <pre class=codehilite><code class=language-sql>postgres=&gt; \\x on
Expanded display is on.
postgres=&gt; select \* from pg\_stat\_replication;
-\[ RECORD 1 \]----+-------------------------------------------
pid              | 74733
usesysid         | 16388
usename          | cloudsqlreplica
application\_name | PROJECT\_ID:REPLICA\_NAME
client\_addr      | REPLICA\_IP
client\_hostname  |
client\_port      | 41660
backend\_start    | 2020-09-28 06:59:38.783981+00
backend\_xmin     |
state            | streaming
sent\_lsn         | 0/2939FFA8
write\_lsn        | 0/2939FFA8
flush\_lsn        | 0/2939FFA8
replay\_lsn       | 0/2939FFA8
write\_lag        |
flush\_lag        |
replay\_lag       |
sync\_priority    | 0
sync\_state       | async
reply\_time       | 2020-09-28 07:17:52.714969+00
postgres=&gt; 
</code></pre> <h4 id=postgresql-database-monitoring>PostgreSQL database monitoring<a class=headerlink href=#postgresql-database-monitoring title="Permanent link">âš‘</a></h4> <p>This section describes some additional monitoring tasks that are considered routine for a PostgreSQL DBA.</p> <h5 id=session-monitoring>Session monitoring<a class=headerlink href=#session-monitoring title="Permanent link">âš‘</a></h5> <p>Oracle sessions are monitored by querying the dynamic performance views known as the <code>"V$"views</code>. </p> <p>The <code>V$SESSION</code> and the <code>V$PROCESS</code> views are commonly used to gain real-time insights about current database activity through SQL statements. </p> <p>You can monitor session activity in PostgreSQL in a similar manner, both through PostgreSQL commands and SQL statements.</p> <p>The PostgreSQL <a href=https://www.postgresql.org/docs/12/monitoring-stats.html#PG-STAT-ACTIVITY-VIEW><code>pg_stat_activity</code></a> dynamic view provides detailed information on current database session activity:</p> <pre class=codehilite><code class=language-sql>postgres=&gt; \\x on
postgres=&gt; select \* from pg\_stat\_activity where backend\_type = 'client backend' and usename != 'cloudsqladmin';
-\[ RECORD 1 \]----+-----------------------------------------------------------------------------------------------------
datid            | 14052
datname          | postgres
pid              | 74750
usesysid         | 16389
usename          | postgres
application\_name | psql
client\_addr      | CLIENT\_IP
client\_hostname  |
client\_port      | 51904
backend\_start    | 2020-09-28 07:01:30.214099+00
xact\_start       | 2020-09-28 07:28:48.982115+00
query\_start      | 2020-09-28 07:28:48.982115+00
state\_change     | 2020-09-28 07:28:48.982117+00
wait\_event\_type  |
wait\_event       |
state            | active
backend\_xid      |
backend\_xmin     | 88513
query            | select \* from pg\_stat\_activity where backend\_type = 'client backend' and usename != 'cloudsqladmin';
backend\_type     | client backend
postgres=&gt; 
</code></pre> <h5 id=long-transaction-monitoring>Long transaction monitoring<a class=headerlink href=#long-transaction-monitoring title="Permanent link">âš‘</a></h5> <p>In order to identify long running transactions that might lead to performance issues, query the <code>pg_stat_activity</code> dynamic view. You can identify long-running queries by applying appropriate filters on columns such as <code>query_start</code> and <code>state</code>.</p> <h5 id=locks-monitoring>Locks monitoring<a class=headerlink href=#locks-monitoring title="Permanent link">âš‘</a></h5> <p>You can monitor database locks through the <a href=https://www.postgresql.org/docs/12/view-pg-locks.html><code>pg_locks</code></a> dynamic view, which provides real-time information about any lock contention that can lead to performance issues.</p> <h4 id=alerting>Alerting<a class=headerlink href=#alerting title="Permanent link">âš‘</a></h4> <p>You can use <a href=https://cloud.google.com/monitoring/alerts>alerting</a> in addition to monitoring and logging. You can also create alerts for conditions.</p> <h3 id=scaling>Scaling<a class=headerlink href=#scaling title="Permanent link">âš‘</a></h3> <p>Cloud SQL for PostgreSQL supports both vertical and horizontal scaling options.</p> <p>You scale vertically by adding more resources to the Cloud SQL instance, such as increasing the instance-assigned number of <a href=https://cloud.google.com/sql/docs/postgres/instance-settings#cpus-postgres>CPUs and memory</a>. Network throughput of your instance depends on the values you choose for CPU and memory.</p> <p>Cloud SQL supports up to 30 TB of storage space. Adding storage capacity generally increases throughput and disk IOPs of an instance. Note that network throughput of a Cloud SQL instance includes reads/writes of your data (disk throughput) as well as the content of queries, calculations, and other data not stored on your database. It's important to consider these factors when vertically scaling your Cloud SQL instance.</p> <p>You scale horizontally by creating <a href=https://cloud.google.com/sql/docs/postgres/replication/create-replica>read replicas</a>. Read replicas let you scale your read workloads onto separate Cloud SQL instances without affecting the performance and availability of the primary instance.</p> <h3 id=backup-and-recovery>Backup and recovery<a class=headerlink href=#backup-and-recovery title="Permanent link">âš‘</a></h3> <p>There are two database backup methods for Cloud SQL for PostgreSQL: on-demand and automated. You can do on-demand backups anytime and they are persisted until you delete them. Automated backups use a 4-hour backup window and are retained for 7 days.</p> <p>You can restore Cloud SQL for PostgreSQL database backups to the same instance, overwriting the existing data, or to a new instance. In addition, Cloud SQL for PostgreSQL lets you restore a PostgreSQL database to a specific <a href=https://cloud.google.com/sql/docs/postgres/backup-recovery/pitr>point in time</a> as long as point-in-time recovery is turned on and the automated backup option is enabled.</p> <p>Cloud SQL for PostgreSQL provides database cloning capabilities. The clone must be created from the primary instance (that is, it cannot be created from a replica). You can run database backups, restores, and clones from either the Cloud Console or the <code>gcloud</code> tool.</p> <h3 id=automation>Automation<a class=headerlink href=#automation title="Permanent link">âš‘</a></h3> <p>You can use the Cloud SQL Admin API to completely automate administering a Cloud SQL for PostgreSQL instance. The Cloud SQL Admin API is a REST API for controlling different types of resources such as Instances, Databases, Users, Flags, Operations, SslCerts, Tiers, and BackupRuns. For more information, see the <a href=https://cloud.google.com/sql/docs/postgres/admin-api/rest>API documentation</a>.</p> <h3 id=whats-next>What's next<a class=headerlink href=#whats-next title="Permanent link">âš‘</a></h3> <ul> <li>Explore more about <a href=https://cloud.google.com/sql/docs/postgres/users>Cloud SQL for PostgreSQL</a> user accounts.</li> <li>Learn more about Cloud SQL for PostgreSQL for Oracle users:<ul> <li><a href=https://cloud.google.com/solutions/migrating-oracle-users-to-cloud-sql-for-postgresql-terminology>Migrating Oracle users to Cloud SQL for PostgreSQL: Terminology and functionality</a></li> <li><a href=https://cloud.google.com/solutions/migrating-oracle-users-to-cloud-sql-for-postgresql-data-types>Migrating Oracle users to Cloud SQL for PostgreSQL: Data types, users, and tables</a></li> <li><a href=https://cloud.google.com/solutions/migrating-oracle-users-to-cloud-sql-for-postgresql-queries>Migrating Oracle users to Cloud SQL for PostgreSQL: Queries, stored procedures, functions, and triggers</a></li> <li><a href=https://cloud.google.com/solutions/migrating-oracle-users-to-cloud-sql-for-postgresql-security>Migrating Oracle users to Cloud SQL for PostgreSQL: Security, operations, monitoring, and logging</a></li> </ul> </li> <li>Explore reference architectures, diagrams, tutorials, and best practices about Google Cloud. Take a look at our <a href=https://cloud.google.com/architecture>Cloud Architecture Center</a>.</li> </ul> <hr> <p>Links: <a href=../Google%20Cloud%20APIs/ >Google Cloud APIs</a> | [[GCP/Google Cloud Setup Notes]] Source: <a href=https://cloud.google.com/solutions/setting-up-cloud-sql-for-postgresql-for-production>Setting up Cloud SQL for PostgreSQL for production use Â |Â  Solutions (google.com)</a></p></div> </div> <footer class="col-md-12 text-center"> <hr> <p> <small>Copyright &copy; 2021 Jimmy Briggs</small><br> <small>Documentation built with <a href=http://www.mkdocs.org/ >MkDocs</a>.</small> </p> </footer> <script src=//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js></script> <script src=../../js/bootstrap-3.0.3.min.js></script> <script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js></script> <script>hljs.initHighlightingOnLoad();</script> <script>var base_url = "../.."</script> <script src=../../js/base.js></script> <script src=../../js/timeago.min.js></script> <script src=../../js/timeago_mkdocs_material.js></script> <script src=../../search/main.js></script> <div class=modal id=mkdocs_search_modal tabindex=-1 role=dialog aria-labelledby=searchModalLabel aria-hidden=true> <div class="modal-dialog modal-lg"> <div class=modal-content> <div class=modal-header> <button type=button class=close data-dismiss=modal> <span aria-hidden=true>&times;</span> <span class=sr-only>Close</span> </button> <h4 class=modal-title id=searchModalLabel>Search</h4> </div> <div class=modal-body> <p> From here you can search these documents. Enter your search terms below. </p> <form> <div class=form-group> <input type=text class=form-control placeholder=Search... id=mkdocs-search-query title="Type search term here"> </div> </form> <div id=mkdocs-search-results></div> </div> <div class=modal-footer> </div> </div> </div> </div><div class=modal id=mkdocs_keyboard_modal tabindex=-1 role=dialog aria-labelledby=keyboardModalLabel aria-hidden=true> <div class=modal-dialog> <div class=modal-content> <div class=modal-header> <h4 class=modal-title id=keyboardModalLabel>Keyboard Shortcuts</h4> <button type=button class=close data-dismiss=modal><span aria-hidden=true>&times;</span><span class=sr-only>Close</span></button> </div> <div class=modal-body> <table class=table> <thead> <tr> <th style="width: 20%;">Keys</th> <th>Action</th> </tr> </thead> <tbody> <tr> <td class="help shortcut"><kbd>?</kbd></td> <td>Open this help</td> </tr> <tr> <td class="next shortcut"><kbd>n</kbd></td> <td>Next page</td> </tr> <tr> <td class="prev shortcut"><kbd>p</kbd></td> <td>Previous page</td> </tr> <tr> <td class="search shortcut"><kbd>s</kbd></td> <td>Search</td> </tr> </tbody> </table> </div> <div class=modal-footer> </div> </div> </div> </div> </body> </html> 